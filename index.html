<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gokulam Astra Architect | Bio-Computational Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 3Dmol.js (WebGL Canvas based molecule viewer - NO SVG used) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Cyber-Biological -->
    <!-- 
         Backgrounds: Deep Space (#05070a), Panel (#0f131a)
         Text: Starlight (#e2e8f0), Dim (#94a3b8)
         Accents: Bio-Cyan (#22d3ee), Hazard-Purple (#a855f7), Success-Green (#4ade80)
    -->

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        deep: '#05070a',
                        panel: '#0f131a',
                        border: '#1e293b',
                        accent: '#22d3ee',
                        accentdim: 'rgba(34, 211, 238, 0.1)'
                    },
                    fontFamily: {
                        sans: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar for Webkit */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #05070a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Chart Container specific overrides to ensure fit */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 200px;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #22d3ee;
            margin-top: -6px;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
    </style>

    <!-- Application Structure Plan: 
         The app is divided into three functional columns (on desktop) to mimic a high-end scientific workstation.
         1. Left: "Input Vector" - Controls for the simulation.
         2. Center: "Visual Core" - The 3D render window.
         3. Right: "Data Stream" - Real-time charts visualizing the hidden mathematics of protein folding.
         
         Reasoning: Protein design is a multi-modal task requiring simultaneous attention to structure (3D), 
         thermodynamics (Energy Chart), and sequence quality (pLDDT Chart). This dashboard layout 
         allows users to correlate these dimensions instantly.
    -->
</head>
<body class="bg-deep text-slate-200 h-screen overflow-hidden flex flex-col font-sans">

    <!-- Header -->
    <header class="h-16 border-b border-border bg-panel flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-3">
            <span class="text-2xl text-accent">‚¨°</span>
            <h1 class="text-xl font-bold tracking-wide">GOKULAM ASTRA <span class="text-slate-500 font-light">ARCHITECT v3.0</span></h1>
        </div>
        <div class="flex items-center gap-4 text-sm font-mono text-slate-400">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span>SYSTEM READY</span>
            </div>
            <div class="px-3 py-1 bg-border rounded border border-slate-700">
                GPU: H100-Sim
            </div>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        
        <!-- LEFT COLUMN: Input Vector -->
        <aside class="w-full lg:w-80 bg-panel border-r border-border flex flex-col overflow-y-auto shrink-0 z-10">
            <div class="p-6 space-y-8">
                
                <!-- Introduction Context -->
                <div class="space-y-2">
                    <h2 class="text-accent text-xs font-bold uppercase tracking-widest">01 // Experiment Setup</h2>
                    <p class="text-xs text-slate-400 leading-relaxed">
                        Configure the de novo design parameters. The RFDiffusion model will condition the latent space generation on your specified target topology and functional constraints.
                    </p>
                </div>

                <!-- Input Controls -->
                <div class="space-y-6">
                    <!-- Target Input -->
                    <div class="space-y-2">
                        <label class="text-xs font-mono text-slate-300">TARGET STRUCTURE (PDB)</label>
                        <div class="grid grid-cols-1 gap-2">
                            <button id="btn-upload" class="w-full py-2 px-3 bg-deep border border-slate-700 rounded hover:border-accent text-left text-xs text-slate-400 flex items-center justify-between transition-colors">
                                <span>üìÅ Upload Local File</span>
                                <span>+</span>
                            </button>
                            <button id="btn-example" class="w-full py-2 px-3 bg-deep border border-slate-700 rounded hover:border-accent text-left text-xs text-slate-400 flex items-center justify-between transition-colors group">
                                <span class="group-hover:text-accent">load_example_1n8z.pdb</span>
                                <span class="text-accent opacity-0 group-hover:opacity-100">‚Üµ</span>
                            </button>
                        </div>
                        <input type="file" id="file-input" class="hidden" accept=".pdb">
                    </div>

                    <!-- Prompt -->
                    <div class="space-y-2">
                        <label class="text-xs font-mono text-slate-300">FUNCTIONAL PROMPT</label>
                        <textarea id="prompt-input" class="w-full h-24 bg-deep border border-slate-700 rounded p-3 text-xs text-slate-300 focus:outline-none focus:border-accent resize-none font-mono" placeholder="> Design a high-affinity binder for the HER2 interface..."></textarea>
                    </div>

                    <!-- Sliders -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-mono text-slate-300">CHAIN LENGTH</label>
                            <span id="length-val" class="text-xs font-bold text-accent">120 res</span>
                        </div>
                        <input type="range" id="length-slider" min="50" max="300" value="120" class="w-full">
                        
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-mono text-slate-300">NOISE SCALE</label>
                            <span class="text-xs font-bold text-purple-400">0.8</span>
                        </div>
                        <div class="w-full h-1 bg-slate-700 rounded overflow-hidden">
                            <div class="h-full bg-purple-500 w-[80%]"></div>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <button id="btn-generate" class="w-full py-4 bg-accent text-deep font-bold uppercase tracking-wider text-sm hover:bg-white transition-colors shadow-[0_0_20px_rgba(34,211,238,0.3)]">
                    Initiate Folding
                </button>
            </div>
        </aside>

        <!-- CENTER COLUMN: Visual Core -->
        <section class="flex-1 bg-black relative flex flex-col min-h-[400px]">
            <!-- Viewer Controls Overlay -->
            <div class="absolute top-4 left-4 z-10 flex gap-2">
                <button onclick="viewerStyles('cartoon')" class="px-3 py-1 bg-panel/80 backdrop-blur border border-slate-700 text-xs rounded hover:text-accent">Cartoon</button>
                <button onclick="viewerStyles('surface')" class="px-3 py-1 bg-panel/80 backdrop-blur border border-slate-700 text-xs rounded hover:text-accent">Surface</button>
                <button onclick="viewerStyles('stick')" class="px-3 py-1 bg-panel/80 backdrop-blur border border-slate-700 text-xs rounded hover:text-accent">Stick</button>
            </div>

            <!-- 3D Canvas -->
            <div id="viewer" class="w-full h-full"></div>

            <!-- Loading Overlay -->
            <div id="loader" class="absolute inset-0 bg-deep/90 backdrop-blur-sm flex flex-col items-center justify-center z-20 hidden">
                <div class="text-4xl text-accent animate-spin mb-4">‚ü≥</div>
                <h3 class="text-xl font-bold">Running Simulation</h3>
                <p id="loader-status" class="text-sm font-mono text-slate-400 mt-2">Initializing diffusion steps...</p>
            </div>

            <!-- Bottom Context Bar -->
            <div class="absolute bottom-0 left-0 right-0 h-10 bg-panel/90 backdrop-blur border-t border-border flex items-center justify-between px-4 text-xs font-mono">
                <span class="text-slate-500">VIEWPORT: <span class="text-slate-300">WebGL 2.0</span></span>
                <span id="model-status" class="text-slate-300">IDLE</span>
            </div>
        </section>

        <!-- RIGHT COLUMN: Data Stream -->
        <aside class="w-full lg:w-96 bg-panel border-l border-border flex flex-col overflow-y-auto shrink-0 z-10">
            <div class="p-6 space-y-8">
                
                <!-- Intro -->
                <div class="space-y-2">
                    <h2 class="text-accent text-xs font-bold uppercase tracking-widest">02 // Real-time Analytics</h2>
                    <p class="text-xs text-slate-400 leading-relaxed">
                        Monitor the trajectory of the folding process. The Energy Landscape shows stability convergence, while the pLDDT scores indicate AlphaFold's confidence in the generated structure.
                    </p>
                </div>

                <!-- Visualization & Content Choices: 
                     1. Energy Landscape (Line Chart): Chosen to visualize the 'convergence' of the folding algorithm over time steps. 
                        Users can see the energy drop (improvement) visually. Interaction: Animation during folding.
                     2. pLDDT Distribution (Bar Chart): Chosen to show the quality of the final protein. 
                        pLDDT is the standard metric for AlphaFold. Bar chart allows per-residue inspection.
                     3. Sequence View (Text): Essential for medicinal chemists to see the amino acid composition.
                -->

                <!-- Chart 1: Energy Landscape -->
                <div class="bg-deep border border-border rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-slate-200">ENERGY LANDSCAPE (ŒîG)</h3>
                        <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">Time Step</span>
                    </div>
                    <!-- Chart Container -->
                    <div class="chart-wrapper">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: pLDDT Quality -->
                <div class="bg-deep border border-border rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-slate-200">RESIDUE CONFIDENCE (pLDDT)</h3>
                        <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">Final Metrics</span>
                    </div>
                    <!-- Chart Container -->
                    <div class="chart-wrapper">
                        <canvas id="plddtChart"></canvas>
                    </div>
                </div>

                <!-- Sequence Output -->
                <div class="space-y-2">
                    <h3 class="text-xs font-bold text-slate-200">GENERATED SEQUENCE</h3>
                    <div id="sequence-box" class="w-full bg-deep border border-slate-700 rounded p-3 text-[10px] font-mono text-slate-400 break-all leading-tight min-h-[60px]">
                        // Awaiting simulation...
                    </div>
                </div>
                
                <!-- KPI Grid -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-deep p-3 rounded border border-border">
                        <div class="text-[10px] text-slate-500 uppercase">Mean pLDDT</div>
                        <div id="stat-plddt" class="text-xl font-mono text-accent">--</div>
                    </div>
                    <div class="bg-deep p-3 rounded border border-border">
                        <div class="text-[10px] text-slate-500 uppercase">RMSD (√Ö)</div>
                        <div id="stat-rmsd" class="text-xl font-mono text-purple-400">--</div>
                    </div>
                </div>

            </div>
        </aside>

    </main>

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. All icons are Unicode or CSS. Charts are Chart.js Canvas. -->

    <script>
        /**
         * GOKULAM ASTRA ENGINE
         * Handles 3D rendering, Simulation Logic, and Data Visualization
         */

        // --- Global State ---
        const state = {
            viewer: null,
            targetPDB: null,
            isSimulating: false,
            energyChart: null,
            plddtChart: null,
            simInterval: null,
            step: 0,
            maxSteps: 20
        };

        // --- 1. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            init3DViewer();
            initCharts();
            setupEventListeners();
        });

        function init3DViewer() {
            const element = document.getElementById('viewer');
            // 3Dmol creates its own canvas inside the element
            state.viewer = $3Dmol.createViewer(element, { backgroundColor: '#000000' });
            state.viewer.render();
        }

        function initCharts() {
            // Energy Chart (Line)
            const ctxEnergy = document.getElementById('energyChart').getContext('2d');
            state.energyChart = new Chart(ctxEnergy, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Free Energy',
                        data: [],
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34, 211, 238, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        x: { display: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { display: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                    animation: false
                }
            });

            // pLDDT Chart (Bar)
            const ctxPlddt = document.getElementById('plddtChart').getContext('2d');
            state.plddtChart = new Chart(ctxPlddt, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Confidence',
                        data: [],
                        backgroundColor: (context) => {
                            const val = context.raw;
                            return val > 90 ? '#22d3ee' : (val > 70 ? '#4ade80' : '#facc15');
                        },
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { min: 0, max: 100, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('btn-example').addEventListener('click', loadExample);
            document.getElementById('file-input').addEventListener('change', handleUpload);
            document.getElementById('btn-upload').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('btn-generate').addEventListener('click', startSimulation);
            document.getElementById('length-slider').addEventListener('input', (e) => {
                document.getElementById('length-val').innerText = e.target.value + ' res';
            });
        }

        // --- 2. Data Handling & Simulation ---

        async function loadExample() {
            document.getElementById('model-status').innerText = 'LOADING 1N8Z...';
            try {
                // Fetching a real PDB for the example
                const response = await fetch('https://files.rcsb.org/download/1N8Z.pdb');
                if (!response.ok) throw new Error("Network response was not ok");
                const pdbText = await response.text();
                state.targetPDB = pdbText;
                
                // Render Target
                state.viewer.clear();
                state.viewer.addModel(pdbText, "pdb");
                state.viewer.setStyle({}, { cartoon: { color: '#334155', opacity: 0.6 } }); // Dark grey for target
                state.viewer.zoomTo();
                state.viewer.render();
                
                document.getElementById('model-status').innerText = 'TARGET LOADED';
                document.getElementById('prompt-input').value = "> Target loaded: HER2 Receptor.\n> Objective: Design binder for Domain IV.";
            } catch (error) {
                console.error(error);
                alert("Failed to load example. Please try uploading a file.");
            }
        }

        function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                state.targetPDB = evt.target.result;
                state.viewer.clear();
                state.viewer.addModel(state.targetPDB, "pdb");
                state.viewer.setStyle({}, { cartoon: { color: '#334155', opacity: 0.6 } });
                state.viewer.zoomTo();
                state.viewer.render();
                document.getElementById('model-status').innerText = 'FILE LOADED';
            };
            reader.readAsText(file);
        }

        function startSimulation() {
            if (!state.targetPDB) {
                alert("Please load a target structure first.");
                return;
            }

            // Reset UI
            state.isSimulating = true;
            document.getElementById('loader').classList.remove('hidden');
            state.step = 0;
            
            // Reset Charts
            state.energyChart.data.labels = [];
            state.energyChart.data.datasets[0].data = [];
            state.energyChart.update();
            
            state.plddtChart.data.labels = [];
            state.plddtChart.data.datasets[0].data = [];
            state.plddtChart.update();

            // Simulation Loop
            const messages = [
                "Initializing RFDiffusion noise...",
                "Sampling backbone latent space...",
                "Optimizing van der Waals contacts...",
                "ProteinMPNN Sequence Decoding...",
                "AlphaFold2 Validation...",
                "Finalizing Solvation..."
            ];

            state.simInterval = setInterval(() => {
                state.step++;
                const progress = state.step / state.maxSteps;
                
                // Update Loader Text
                const msgIndex = Math.floor(progress * (messages.length - 1));
                document.getElementById('loader-status').innerText = messages[msgIndex];

                // Update Energy Chart (Simulated Data)
                // Energy should generally decrease (become more negative)
                const randomNoise = (Math.random() - 0.5) * 5;
                const energy = -10 - (progress * 40) + randomNoise; // Start at -10, go to -50
                
                state.energyChart.data.labels.push(state.step);
                state.energyChart.data.datasets[0].data.push(energy);
                state.energyChart.update('none'); // 'none' for performance

                // 3D Visual Update (Mocking the folding process)
                if (state.step % 5 === 0) {
                   // In a real app, we would update coordinates here. 
                   // Since we can't efficiently generate PDB strings in JS, we just rotate the view to simulate activity
                   state.viewer.rotate(10);
                }

                if (state.step >= state.maxSteps) {
                    finishSimulation();
                }

            }, 200); // 200ms per step
        }

        function finishSimulation() {
            clearInterval(state.simInterval);
            state.isSimulating = false;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('model-status').innerText = 'DESIGN COMPLETE';

            // 1. Generate Final Mock Structure (Helix)
            const length = parseInt(document.getElementById('length-slider').value);
            const pdbBlock = generateHelixPDB(length);
            
            state.viewer.addModel(pdbBlock, "pdb");
            state.viewer.setStyle({model: -1}, { cartoon: { color: '#22d3ee' } }); // Cyan for new design
            state.viewer.zoomTo();
            state.viewer.render();

            // 2. Generate Sequence
            const aas = "ACDEFGHIKLMNPQRSTVWY";
            let seq = "";
            let plddtData = [];
            let plddtLabels = [];
            let totalPlddt = 0;

            for(let i=0; i<length; i++) {
                seq += aas[Math.floor(Math.random() * aas.length)];
                // Simulate pLDDT: ends are usually lower confidence, middle is higher
                const distFromCenter = Math.abs(i - length/2);
                const confidence = 95 - (distFromCenter / length * 40) + (Math.random() * 5); 
                plddtData.push(confidence);
                plddtLabels.push(i+1);
                totalPlddt += confidence;
            }

            document.getElementById('sequence-box').innerText = seq;

            // 3. Update pLDDT Chart
            state.plddtChart.data.labels = plddtLabels;
            state.plddtChart.data.datasets[0].data = plddtData;
            state.plddtChart.update();

            // 4. Update Stats
            document.getElementById('stat-plddt').innerText = (totalPlddt / length).toFixed(1);
            document.getElementById('stat-rmsd').innerText = (0.5 + Math.random()).toFixed(2);
        }

        // --- 3. Utilities ---

        function viewerStyles(style) {
            if (!state.targetPDB) return;
            state.viewer.setStyle({}, {}); // Clear current
            
            // Re-apply style based on selection
            if (style === 'cartoon') {
                state.viewer.setStyle({model: 0}, {cartoon: {color: '#334155', opacity: 0.6}}); // Target
                state.viewer.setStyle({model: 1}, {cartoon: {color: '#22d3ee'}}); // Design
            } else if (style === 'surface') {
                state.viewer.addSurface($3Dmol.SurfaceType.VDW, {opacity:0.7, color:'#334155'}, {model:0});
                state.viewer.setStyle({model: 1}, {cartoon: {color: '#22d3ee'}});
            } else if (style === 'stick') {
                state.viewer.setStyle({}, {stick: {}});
            }
            state.viewer.render();
        }

        // Helper to generate a dummy Alpha Helix PDB string
        function generateHelixPDB(numResidues) {
            let pdb = "";
            let atomSerial = 1;
            
            for (let i = 0; i < numResidues; i++) {
                // Alpha helix parameters: 1.5A rise per residue, 100 degrees rotation
                const angle = i * (100 * Math.PI / 180);
                const radius = 2.3; // Approx radius of alpha helix CA
                const rise = i * 1.5;
                
                // Centered somewhat away from origin to "dock"
                const x = (radius * Math.cos(angle)) + 15;
                const y = (radius * Math.sin(angle)) + 15;
                const z = rise;
                
                // PDB Format specific padding
                const xStr = x.toFixed(3).padStart(8);
                const yStr = y.toFixed(3).padStart(8);
                const zStr = z.toFixed(3).padStart(8);
                const seqId = (i + 1).toString().padStart(4);
                
                pdb += `ATOM  ${atomSerial.toString().padStart(5)}  CA  ALA A${seqId}    ${xStr}${yStr}${zStr}  1.00 90.00           C  \n`;
                atomSerial++;
            }
            return pdb;
        }

    </script>
</body>
</html>